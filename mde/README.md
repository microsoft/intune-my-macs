# üõ°Ô∏è Microsoft Defender for Endpoint (MDE)

This folder contains Microsoft Defender for Endpoint configurations for macOS, including onboarding profiles, settings catalog policies, and installation scripts.

---

## ‚ö†Ô∏è Important: Onboarding File Required

**Before deploying MDE configurations, you must obtain your organization's unique onboarding file.**

The `cfg-mde-001-onboarding.mobileconfig` file included in this repository is **environment-specific** and will **not work** in your tenant. Each organization has a unique onboarding package generated by Microsoft Defender for Endpoint.

---

## üîë Getting Your Onboarding File

### Step 1: Download from Microsoft Defender Portal

1. Sign in to the [Microsoft Defender Portal](https://security.microsoft.com)
2. Navigate to **Settings** > **Endpoints** > **Device management** > **Onboarding**
3. Select **Operating System**: **macOS**
4. Select **Deployment method**: **Mobile Device Management / Microsoft Intune**
5. Click **Download onboarding package**

This downloads a file named `WindowsDefenderATPOnboarding.mobileconfig` (yes, it's named "Windows" even for macOS).

**Documentation:** [Onboard macOS devices to Microsoft Defender for Endpoint](https://learn.microsoft.com/microsoft-365/security/defender-endpoint/mac-install-with-intune)

### Step 2: Rename and Place the File

Rename the downloaded file to match the expected name in this project:

```bash
# From your Downloads folder:
mv ~/Downloads/WindowsDefenderATPOnboarding.mobileconfig \
   /path/to/intune-my-macs/mde/cfg-mde-001-onboarding.mobileconfig
```

**Important:** The file **must** be named `cfg-mde-001-onboarding.mobileconfig` exactly as shown.

### Step 3: Deploy

Once you've placed your onboarding file, run the main deployment script:

```bash
pwsh ./mainScript.ps1 --assign-group "Pilot Macs" --mde
```

The `--mde` flag is required to include Microsoft Defender artifacts in the deployment.

---

## üì¶ What's Included

### CFG-MDE-001 - Onboarding Profile
**File:** `cfg-mde-001-onboarding.mobileconfig`

- **Type:** Custom Configuration Profile (mobileconfig)
- **Purpose:** Onboards macOS devices to Microsoft Defender for Endpoint
- **Critical:** Must be replaced with your organization's unique onboarding file
- **Deployment:** Assigned to devices via Intune MDM

### POL-MDE-001 - Settings Catalog
**Files:** `pol-mde-001-settings-catalog.json` / `.xml`

- **Type:** Intune Settings Catalog Policy
- **Purpose:** Configures Microsoft Defender for Endpoint behavior and features
- **Includes:**
  - Antivirus settings
  - Real-time protection configuration
  - Cloud-delivered protection
  - Exclusions and performance tuning
  - Threat type settings

### SCR-MDE-100 - Install Defender
**Files:** `scr-mde-100-install-defender.zsh` / `.xml`

- **Type:** Shell Script
- **Purpose:** Automated installation of Microsoft Defender for Endpoint
- **Features:**
  - Waits for core Microsoft apps to be present
  - Ensures Rosetta 2 is installed (for Apple Silicon Macs)
  - Uses Last-Modified header to skip unnecessary reinstalls
  - Downloads latest MDE PKG from Microsoft CDN
  - Runs as system account with retry logic

---

## üöÄ Deployment Order

For successful MDE deployment, follow this recommended order:

1. **SCR-MDE-100** - Install Microsoft Defender application
2. **CFG-MDE-001** - Onboard devices to Defender for Endpoint service
3. **POL-MDE-001** - Configure Defender settings and policies

The `mainScript.ps1` deployment script handles this ordering automatically when using the `--mde` flag.

---

## üîß Configuration

### Testing in a Pilot Group

Deploy to a small pilot group first:

```bash
pwsh ./mainScript.ps1 --assign-group "MDE Pilot Group" --mde
```

### Production Deployment

Once validated, deploy to your production group:

```bash
pwsh ./mainScript.ps1 --assign-group "All Managed Macs" --mde
```

### Updating Settings

To update MDE settings after initial deployment:

1. Modify `pol-mde-001-settings-catalog.json`
2. Run the deployment script again (it will update existing policies)
3. Wait for Intune to sync changes to devices (~1 hour)

---

## üîç Verification

### Verify Onboarding Status

On a managed Mac, check if Defender is onboarded:

```bash
# Check Defender status
sudo mdatp health

# Check onboarding status specifically
sudo mdatp health --field org_id
```

If `org_id` shows a GUID, the device is successfully onboarded.

### Check Defender Version

```bash
sudo mdatp version
```

### View Real-Time Protection Status

```bash
sudo mdatp health --field real_time_protection_enabled
```

---

## üö® Troubleshooting

### Onboarding File Not Found

**Error:** "Cannot find onboarding.mobileconfig"

**Solution:** 
1. Verify the file is named exactly `cfg-mde-001-onboarding.mobileconfig`
2. Ensure it's in the `mde/` folder
3. Check you're running `mainScript.ps1` with the `--mde` flag

### Device Not Onboarding

**Error:** Device shows in Intune but not in Defender Portal

**Checklist:**
1. Verify the onboarding profile is assigned to the device
2. Check the device has received and installed the configuration (Intune device details)
3. Run `sudo mdatp health` on the device to see error messages
4. Ensure network access to Microsoft Defender cloud services (ports 80/443)
5. Wait up to 24 hours - initial onboarding can take time

### Installation Script Failures

**Error:** Install script fails with Rosetta errors

**Solution:** The script automatically installs Rosetta 2, but network issues can cause failures. Manually install:

```bash
softwareupdate --install-rosetta --agree-to-license
```

### Conflicting Security Software

**Warning:** Other antivirus or endpoint protection software can conflict with MDE

**Solution:** 
- Uninstall competing security products before deploying MDE
- Use Intune shell scripts to remove conflicting software first
- Check for kernel extensions that might interfere

---

## üìã Requirements

### License Requirements

- Microsoft Defender for Endpoint Plan 1 or Plan 2
- Microsoft 365 E5 / A5 / G5
- OR Microsoft Defender for Endpoint standalone license

### macOS Requirements

- macOS 11 (Big Sur) or later
- Apple Silicon (M1/M2/M3) or Intel Macs
- Network connectivity to Microsoft cloud services

### Intune Requirements

- Valid APNS certificate
- Device enrolled in Microsoft Intune
- Full Disk Access approval (granted automatically via MDM profile)

---

## üìö Additional Resources

- [Microsoft Defender for Endpoint on macOS](https://learn.microsoft.com/microsoft-365/security/defender-endpoint/microsoft-defender-endpoint-mac)
- [Deploy MDE for macOS with Intune](https://learn.microsoft.com/microsoft-365/security/defender-endpoint/mac-install-with-intune)
- [MDE for macOS command-line reference](https://learn.microsoft.com/microsoft-365/security/defender-endpoint/mac-resources)
- [Troubleshooting MDE on macOS](https://learn.microsoft.com/microsoft-365/security/defender-endpoint/mac-support-install)
- [Performance tuning for MDE on macOS](https://learn.microsoft.com/microsoft-365/security/defender-endpoint/mac-support-perf)

---

## üîê Security Note

**Never commit your organization's onboarding file to public repositories.** The onboarding file contains sensitive information that could allow unauthorized devices to appear as corporate assets in your Defender portal.

If you've accidentally committed an onboarding file:
1. Rotate the onboarding package in the Defender Portal (Settings > Endpoints > Onboarding > Rotate)
2. Remove the file from Git history
3. Download and deploy the new onboarding package

---

## üí° Best Practices

1. **Test First:** Always deploy to a pilot group before production
2. **Monitor Onboarding:** Check the Defender Portal device inventory after deployment
3. **Regular Updates:** MDE auto-updates, but monitor for any failed updates
4. **Review Alerts:** Configure alert policies in the Defender Portal
5. **Performance Monitoring:** Watch for high CPU/memory usage and tune exclusions if needed
6. **Exclusions:** Add necessary exclusions for developer tools or performance-sensitive apps
7. **User Communication:** Inform users about the security software and what to expect

---

Built with ‚ù§Ô∏è by the **Microsoft Intune Customer Experience Engineering team**
